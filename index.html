<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>One Piece Crew Builder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Pirata+One&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0b1a2b; /* Deep Sea Blue */
        }
        .title-font {
            font-family: 'Pirata One', cursive;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        .card {
            transition: transform 0.2s, box-shadow 0.2s;
            border: 3px solid transparent;
            background-color: #173f67; /* Darker Blue */
        }
        .card-drawn {
            border-color: #ffd700; /* Gold highlight when drawn */
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
        }
        .slot {
            transition: background-color 0.2s;
            min-height: 12rem;
            background-color: #0d2847; /* Slot background */
            border: 1px dashed #4e73a0;
        }
        .slot-active {
            animation: pulse-border 1s infinite alternate;
            cursor: pointer;
        }
        .slot-active:hover {
            background-color: #1e4a7a;
        }
        @keyframes pulse-border {
            from { border-color: #ffaa00; }
            to { border-color: #ffaa00; }
        }
        .player-highlight {
            border: 4px solid #ffaa00;
            box-shadow: 0 0 20px rgba(255, 170, 0, 0.5);
        }
        .button-primary {
            background-color: #e53e3e; /* Red for Skip/Action */
            box-shadow: 0 4px #9b2c2c;
            transition: background-color 0.1s, transform 0.1s, box-shadow 0.1s;
        }
        .button-primary:active {
            transform: translateY(2px);
            box-shadow: 0 2px #9b2c2c;
        }
        .button-secondary {
            background-color: #38a169; /* Green for Draw */
            box-shadow: 0 4px #2f855a;
            transition: background-color 0.1s, transform 0.1s, box-shadow 0.1s;
        }
        .button-secondary:active {
            transform: translateY(2px);
            box-shadow: 0 2px #2f855a;
        }
    </style>
</head>
<body>

<div id="app" class="min-h-screen p-4 sm:p-8 text-white">

    <!-- Game Title -->
    <header class="text-center mb-6 sm:mb-10">
        <h1 class="title-font text-5xl sm:text-7xl font-bold text-yellow-400 drop-shadow-lg mb-2">
            One Piece Crew Builder
        </h1>
        <p id="game-status" class="text-xl font-semibold text-gray-300"></p>
    </header>

    <!-- Main Game Area -->
    <div class="max-w-7xl mx-auto">
        
        <!-- Player Boards (Flex container for responsive layout) -->
        <div class="flex flex-col lg:flex-row gap-8 mb-8">
            <!-- Player 1 Board -->
            <div id="player-1-board" class="lg:w-1/2 p-4 rounded-xl shadow-2xl transition duration-300" style="background-color: #123456;">
                <h2 class="title-font text-3xl mb-4 text-center text-yellow-300">Player 1: Straw Hat Crew</h2>
                <div id="crew-1" class="grid grid-cols-2 md:grid-cols-3 gap-3">
                    <!-- Slots will be injected here -->
                </div>
            </div>

            <!-- Player 2 Board -->
            <div id="player-2-board" class="lg:w-1/2 p-4 rounded-xl shadow-2xl transition duration-300" style="background-color: #123456;">
                <h2 class="title-font text-3xl mb-4 text-center text-yellow-300">Player 2: Pirate Alliance</h2>
                <div id="crew-2" class="grid grid-cols-2 md:grid-cols-3 gap-3">
                    <!-- Slots will be injected here -->
                </div>
            </div>
        </div>

        <!-- Card Pool & Controls -->
        <div id="controls-area" class="bg-gray-800/70 p-6 rounded-xl shadow-inner border border-gray-700">
            <h3 class="text-2xl font-semibold text-center mb-4 text-cyan-300">Drafting Pool (<span id="deck-count">X</span> Cards Left)</h3>
            
            <!-- Card Pool (Only one card shown) -->
            <div id="card-pool" class="flex justify-center gap-4 mb-6 min-h-48">
                <!-- Card will be injected here -->
            </div>

            <!-- Actions -->
            <div class="flex justify-center gap-4 flex-wrap">
                <button id="draw-button" onclick="drawCard()" class="button-secondary text-white py-3 px-6 rounded-lg font-bold uppercase disabled:opacity-50 disabled:shadow-none hover:bg-green-600 transition">
                    Draw Card
                </button>
                <button id="skip-button" onclick="skipTurn()" class="button-primary text-white py-3 px-6 rounded-lg font-bold uppercase disabled:opacity-50 disabled:shadow-none hover:bg-red-600 transition">
                    Skip Card (<span id="player-skip-status">1</span> Left)
                </button>
                <button id="new-game-button" onclick="initGame()" class="bg-gray-500 text-white py-3 px-6 rounded-lg font-bold uppercase shadow-md hidden">
                    New Game
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // --- Game Data ---
    const ROLES = ['Captain', 'Vice Captain', 'Tank', 'Healer', 'Support'];
    const CREW_SLOTS = [
        { name: 'Captain', count: 1 },
        { name: 'Vice Captain', count: 1 },
        { name: 'Tank', count: 1 },
        { name: 'Healer', count: 1 },
        { name: 'Support', count: 2 }
    ].flatMap(slot => Array(slot.count).fill(slot.name));

    // Expanded Character Roster (40 Cards)
    const CARDS = [
        // Straw Hats + Allies
        { id: 'luffy', name: 'Monkey D. Luffy', role_affinity: ['Captain', 'Support'], stats: { Attack: 90, Defense: 60, Healing: 10 }, img_url: 'https://placehold.co/100x140/f33/000?text=L' },
        { id: 'zoro', name: 'Roronoa Zoro', role_affinity: ['Vice Captain', 'Tank'], stats: { Attack: 85, Defense: 70, Healing: 5 }, img_url: 'https://placehold.co/100x140/3c3/000?text=Z' },
        { id: 'nami', name: 'Nami', role_affinity: ['Support'], stats: { Attack: 40, Defense: 20, Healing: 50 }, img_url: 'https://placehold.co/100x140/fa5/000?text=N' },
        { id: 'sanji', name: 'Vinsmoke Sanji', role_affinity: ['Vice Captain', 'Support'], stats: { Attack: 75, Defense: 50, Healing: 25 }, img_url: 'https://placehold.co/100x140/55a/000?text=S' },
        { id: 'chopper', name: 'T.T. Chopper', role_affinity: ['Healer', 'Support'], stats: { Attack: 30, Defense: 40, Healing: 80 }, img_url: 'https://placehold.co/100x140/c3c/000?text=C' },
        { id: 'robin', name: 'Nico Robin', role_affinity: ['Support'], stats: { Attack: 50, Defense: 30, Healing: 30 }, img_url: 'https://placehold.co/100x140/5af/000?text=R' },
        { id: 'franky', name: 'Franky', role_affinity: ['Tank', 'Support'], stats: { Attack: 60, Defense: 80, Healing: 0 }, img_url: 'https://placehold.co/100x140/888/000?text=F' },
        { id: 'jinbe', name: 'Jinbe', role_affinity: ['Tank', 'Vice Captain'], stats: { Attack: 70, Defense: 95, Healing: 5 }, img_url: 'https://placehold.co/100x140/007/FFF?text=J' },
        { id: 'brook', name: 'Brook', role_affinity: ['Support'], stats: { Attack: 55, Defense: 25, Healing: 30 }, img_url: 'https://placehold.co/100x140/fff/000?text=B' },
        { id: 'ussop', name: 'God Usopp', role_affinity: ['Support'], stats: { Attack: 45, Defense: 30, Healing: 35 }, img_url: 'https://placehold.co/100x140/6a0/000?text=U' },
        { id: 'law', name: 'Trafalgar Law', role_affinity: ['Healer', 'Captain'], stats: { Attack: 80, Defense: 40, Healing: 60 }, img_url: 'https://placehold.co/100x140/04a/FFF?text=T' },
        { id: 'kid', name: 'Eustass Kid', role_affinity: ['Vice Captain', 'Tank'], stats: { Attack: 88, Defense: 72, Healing: 0 }, img_url: 'https://placehold.co/100x140/f80/000?text=K' },
        { id: 'sabo', name: 'Sabo', role_affinity: ['Vice Captain', 'Captain'], stats: { Attack: 90, Defense: 65, Healing: 5 }, img_url: 'https://placehold.co/100x140/055/FFF?text=Sa' },
        { id: 'vivi', name: 'Vivi Nefertari', role_affinity: ['Healer', 'Support'], stats: { Attack: 30, Defense: 20, Healing: 65 }, img_url: 'https://placehold.co/100x140/4ac/FFF?text=Vi' },
        
        // Emperors & Commanders
        { id: 'shanks', name: 'Shanks', role_affinity: ['Captain'], stats: { Attack: 100, Defense: 70, Healing: 0 }, img_url: 'https://placehold.co/100x140/aa0/000?text=Sh' },
        { id: 'ace', name: 'Portgas D. Ace', role_affinity: ['Captain', 'Vice Captain'], stats: { Attack: 95, Defense: 50, Healing: 5 }, img_url: 'https://placehold.co/100x140/f00/000?text=A' },
        { id: 'katakuri', name: 'Katakuri', role_affinity: ['Vice Captain', 'Tank'], stats: { Attack: 93, Defense: 80, Healing: 0 }, img_url: 'https://placehold.co/100x140/c0f/000?text=Ka' },
        { id: 'marco', name: 'Marco the Phoenix', role_affinity: ['Healer', 'Support'], stats: { Attack: 70, Defense: 60, Healing: 95 }, img_url: 'https://placehold.co/100x140/0ff/000?text=Ma' },
        { id: 'king', name: 'King', role_affinity: ['Tank', 'Vice Captain'], stats: { Attack: 82, Defense: 98, Healing: 0 }, img_url: 'https://placehold.co/100x140/333/FFF?text=Ki' },
        { id: 'beckmann', name: 'Ben Beckmann', role_affinity: ['Vice Captain', 'Support'], stats: { Attack: 90, Defense: 70, Healing: 0 }, img_url: 'https://placehold.co/100x140/555/FFF?text=Be' },
        { id: 'jozu', name: 'Jozu', role_affinity: ['Tank'], stats: { Attack: 78, Defense: 95, Healing: 0 }, img_url: 'https://placehold.co/100x140/5af/000?text=Jo' },
        { id: 'smoothie', name: 'Smoothie', role_affinity: ['Vice Captain', 'Support'], stats: { Attack: 80, Defense: 60, Healing: 15 }, img_url: 'https://placehold.co/100x140/fcc/000?text=Sm' },
        { id: 'lasky', name: 'Lucky Roux', role_affinity: ['Tank', 'Support'], stats: { Attack: 70, Defense: 70, Healing: 20 }, img_url: 'https://placehold.co/100x140/999/000?text=Lu' },
        { id: 'yasopp', name: 'Yasopp', role_affinity: ['Support'], stats: { Attack: 85, Defense: 40, Healing: 0 }, img_url: 'https://placehold.co/100x140/666/FFF?text=Ya' },

        // Warlords & Marines
        { id: 'hancock', name: 'Boa Hancock', role_affinity: ['Vice Captain', 'Support'], stats: { Attack: 85, Defense: 40, Healing: 15 }, img_url: 'https://placehold.co/100x140/f6a/000?text=Bo' },
        { id: 'doffy', name: 'Doflamingo', role_affinity: ['Captain'], stats: { Attack: 92, Defense: 55, Healing: 3 }, img_url: 'https://placehold.co/100x140/90c/FFF?text=Do' },
        { id: 'mihawk', name: 'Dracule Mihawk', role_affinity: ['Vice Captain', 'Tank'], stats: { Attack: 98, Defense: 75, Healing: 0 }, img_url: 'https://placehold.co/100x140/000/FFF?text=Mi' },
        { id: 'kuma', name: 'Bartholomew Kuma', role_affinity: ['Tank', 'Support'], stats: { Attack: 65, Defense: 100, Healing: 0 }, img_url: 'https://placehold.co/100x140/ccc/000?text=Ku' },
        { id: 'smoker', name: 'Smoker', role_affinity: ['Tank', 'Vice Captain'], stats: { Attack: 70, Defense: 88, Healing: 0 }, img_url: 'https://placehold.co/100x140/777/FFF?text=Sm' },
        { id: 'koby', name: 'Koby', role_affinity: ['Support'], stats: { Attack: 65, Defense: 45, Healing: 10 }, img_url: 'https://placehold.co/100x140/0af/000?text=Ko' },
        { id: 'garp', name: 'Garp', role_affinity: ['Captain', 'Tank'], stats: { Attack: 97, Defense: 90, Healing: 0 }, img_url: 'https://placehold.co/100x140/a50/FFF?text=Ga' },
        { id: 'fujitora', name: 'Fujitora', role_affinity: ['Tank', 'Captain'], stats: { Attack: 85, Defense: 92, Healing: 0 }, img_url: 'https://placehold.co/100x140/229/FFF?text=Fu' },
        { id: 'akainu', name: 'Akainu', role_affinity: ['Captain'], stats: { Attack: 99, Defense: 80, Healing: 0 }, img_url: 'https://placehold.co/100x140/f30/000?text=Ak' },
        { id: 'aokiji', name: 'Aokiji', role_affinity: ['Vice Captain', 'Tank'], stats: { Attack: 88, Defense: 85, Healing: 0 }, img_url: 'https://placehold.co/100x140/33f/FFF?text=Ao' },

        // Other Notables
        { id: 'perona', name: 'Perona', role_affinity: ['Support'], stats: { Attack: 35, Defense: 25, Healing: 45 }, img_url: 'https://placehold.co/100x140/f9f/000?text=Pe' },
        { id: 'ivankov', name: 'E. Ivankov', role_affinity: ['Healer', 'Support'], stats: { Attack: 50, Defense: 30, Healing: 70 }, img_url: 'https://placehold.co/100x140/a0a/FFF?text=Iv' },
        { id: 'hatchan', name: 'Hatchan', role_affinity: ['Tank', 'Support'], stats: { Attack: 55, Defense: 65, Healing: 10 }, img_url: 'https://placehold.co/100x140/0f8/000?text=Ha' },
        { id: 'buggy', name: 'Buggy D. Clown', role_affinity: ['Captain', 'Support'], stats: { Attack: 20, Defense: 15, Healing: 15 }, img_url: 'https://placehold.co/100x140/d00/FFF?text=Bu' },
        { id: 'bartolomeo', name: 'Bartolomeo', role_affinity: ['Tank', 'Support'], stats: { Attack: 60, Defense: 75, Healing: 0 }, img_url: 'https://placehold.co/100x140/aa2/000?text=Ba' },
        { id: 'cavendish', name: 'Cavendish', role_affinity: ['Vice Captain', 'Support'], stats: { Attack: 80, Defense: 35, Healing: 10 }, img_url: 'https://placehold.co/100x140/fff/333?text=Ca' },
        { id: 'senor', name: 'Senor Pink', role_affinity: ['Tank'], stats: { Attack: 65, Defense: 85, Healing: 0 }, img_url: 'https://placehold.co/100x140/f55/000?text=SP' },
        { id: 'hawkins', name: 'Basil Hawkins', role_affinity: ['Support'], stats: { Attack: 50, Defense: 40, Healing: 30 }, img_url: 'https://placehold.co/100x140/444/FFF?text=BH' },
        { id: 'apoos', name: 'Scratchmen Apoo', role_affinity: ['Support'], stats: { Attack: 70, Defense: 30, Healing: 10 }, img_url: 'https://placehold.co/100x140/888/000?text=SA' },
        { id: 'urouge', name: 'Urouge', role_affinity: ['Tank'], stats: { Attack: 75, Defense: 75, Healing: 0 }, img_url: 'https://placehold.co/100x140/944/FFF?text=Ur' },
    ];

    // --- Game State ---
    let gameState = {
        deck: [],
        cardPool: [], 
        currentPlayer: 1,
        players: {
            1: { team: [], skipped: false, score: 0 },
            2: { team: [], skipped: false, score: 0 }
        },
        totalTurns: 0,
        gameEnded: false,
        cardDrawn: false, 
    };

    // --- Utility Functions ---

    /**
     * Fisher-Yates (Knuth) Shuffle.
     * @param {Array<Object>} array The array to shuffle.
     */
    function shuffleArray(array) {
        let currentIndex = array.length, randomIndex;
        while (currentIndex !== 0) {
            randomIndex = Math.floor(Math.random() * currentIndex);
            currentIndex--;
            [array[currentIndex], array[randomIndex]] = [
                array[randomIndex], array[currentIndex]];
        }
        return array;
    }

    /**
     * Initializes the game state.
     */
    function initGame() {
        console.log("Game initialized.");
        gameState.deck = shuffleArray([...CARDS]);
        gameState.players[1].team = CREW_SLOTS.map(role => ({ role, card: null }));
        gameState.players[2].team = CREW_SLOTS.map(role => ({ role, card: null }));
        gameState.currentPlayer = 1;
        gameState.players[1].skipped = false;
        gameState.players[2].skipped = false;
        gameState.gameEnded = false;
        gameState.totalTurns = 0;
        gameState.cardPool = [];
        gameState.cardDrawn = false;
        
        document.getElementById('new-game-button').classList.add('hidden');
        
        renderGame();
    }

    /**
     * Draws one card for the player to consider.
     * @param {boolean} doRender If true, calls renderGame(). Used to prevent double rendering during skip.
     */
    function drawCard(doRender = true) {
        // Only run if a card is not already drawn
        if (gameState.gameEnded || gameState.cardDrawn) return; 
        
        if (gameState.deck.length === 0) {
            document.getElementById('game-status').textContent = "Deck is empty! You must place remaining cards.";
            return;
        }

        gameState.cardPool = [gameState.deck.pop()];
        gameState.cardDrawn = true;
        
        if (doRender) {
            renderGame();
        }
    }

    /**
     * Calculates the score for a player's crew.
     * @param {Array<Object>} team The player's crew array.
     * @returns {number} The calculated score.
     */
    function calculateScore(team) {
        let score = 0;
        let captainAttack = 0;
        
        team.forEach(slot => {
            if (slot.card) {
                const card = slot.card;
                const role = slot.role;
                
                // 1. Base Score
                score += card.stats.Attack + card.stats.Defense + card.stats.Healing;

                // 2. Role Synergy Bonus
                if (card.role_affinity.includes(role)) {
                    score += 50; // Major Bonus
                }

                // 3. Track Captain Attack for Multiplier
                if (role === 'Captain') {
                    captainAttack = card.stats.Attack;
                }
            }
        });

        // 3. Captain Bonus (Multiplicative)
        if (captainAttack > 0) {
            score += Math.round(captainAttack * 0.5); 
        }

        return score;
    }

    /**
     * Checks if the game has ended and determines the winner.
     */
    function checkGameEnd() {
        const crew1Count = gameState.players[1].team.filter(s => s.card !== null).length;
        const crew2Count = gameState.players[2].team.filter(s => s.card !== null).length;

        // Game ends when both crews are full
        if (crew1Count === 6 && crew2Count === 6) {
            gameState.gameEnded = true;
            gameState.players[1].score = calculateScore(gameState.players[1].team);
            gameState.players[2].score = calculateScore(gameState.players[2].team);
            
            let message = `Game Over! Final Scores: Player 1 (${gameState.players[1].score}) vs Player 2 (${gameState.players[2].score}). `;
            if (gameState.players[1].score > gameState.players[2].score) {
                message += "Player 1 wins and establishes the strongest crew!";
            } else if (gameState.players[2].score > gameState.players[1].score) {
                message += "Player 2 wins and establishes the strongest crew!";
            } else {
                message += "It's a tie! Both crews are equally powerful!";
            }
            document.getElementById('game-status').textContent = message;
            document.getElementById('new-game-button').classList.remove('hidden');
        }
    }

    // --- UI Rendering ---

    /**
     * Renders the current state of the game.
     */
    function renderGame() {
        // Status Update
        if (!gameState.gameEnded) {
            const playerState = gameState.cardDrawn ? 'Place the Card or Skip it.' : 'Click "Draw Card" to start your turn.';
            document.getElementById('game-status').textContent = 
                `Turn: ${gameState.totalTurns + 1}. It is Player ${gameState.currentPlayer}'s turn. ${playerState}`;
        }
        document.getElementById('deck-count').textContent = gameState.deck.length;

        renderPlayerHighlights();
        renderCardPool();
        renderPlayerBoards();
        renderControls();
    }
    
    /**
     * Highlights the current player's board.
     */
    function renderPlayerHighlights() {
        document.getElementById('player-1-board').classList.remove('player-highlight');
        document.getElementById('player-2-board').classList.remove('player-highlight');
        if (!gameState.gameEnded) {
            document.getElementById(`player-${gameState.currentPlayer}-board`).classList.add('player-highlight');
        }
    }

    /**
     * Renders the single drawn card.
     */
    function renderCardPool() {
        const poolEl = document.getElementById('card-pool');
        poolEl.innerHTML = '';
        
        if (gameState.cardPool.length === 0) {
            poolEl.innerHTML = `
                <div class="text-center p-4 border border-gray-600 rounded-lg w-full sm:w-40 h-48 flex items-center justify-center">
                    <p class="text-sm text-gray-400 font-semibold">
                        ${gameState.gameEnded ? 'Draft Complete' : 'Card Pool Empty'}
                    </p>
                </div>`;
            return;
        }

        const card = gameState.cardPool[0];
        const affinityText = card.role_affinity.join(', ');

        const cardHtml = `
            <div class="card card-drawn w-full sm:w-40 p-3 rounded-lg shadow-lg">
                <img src="${card.img_url}" alt="${card.name}" class="w-full h-auto rounded-md mb-2" onerror="this.onerror=null; this.src='https://placehold.co/100x140/0d2847/ccc?text=Card';" >
                <h4 class="text-lg font-bold truncate text-yellow-300">${card.name}</h4>
                <p class="text-xs mb-1">Affinity: <span class="text-cyan-400">${affinityText}</span></p>
                <div class="text-xs space-y-0.5 text-gray-300">
                    <p>‚öîÔ∏è Atk: ${card.stats.Attack}</p>
                    <p>üõ°Ô∏è Def: ${card.stats.Defense}</p>
                    <p>üß™ Heal: ${card.stats.Healing}</p>
                </div>
            </div>
        `;
        poolEl.innerHTML += cardHtml;
    }

    /**
     * Renders both player crew boards.
     */
    function renderPlayerBoards() {
        for (let playerId of [1, 2]) {
            const crewEl = document.getElementById(`crew-${playerId}`);
            crewEl.innerHTML = '';
            
            gameState.players[playerId].team.forEach((slot, index) => {
                const isCurrentPlayer = gameState.currentPlayer === playerId;
                // Slot is active if it's the current player, a card is drawn, and the slot is empty
                const isReadyToPlace = isCurrentPlayer && gameState.cardDrawn && !slot.card; 
                
                const card = slot.card;
                let cardContent = '';
                
                if (card) {
                    const isSynergistic = card.role_affinity.includes(slot.role);
                    cardContent = `
                        <img src="${card.img_url}" alt="${card.name}" class="w-full h-auto rounded-md mb-2" onerror="this.onerror=null; this.src='https://placehold.co/100x140/0d2847/ccc?text=Card';">
                        <h4 class="text-sm font-bold truncate text-yellow-300">${card.name}</h4>
                        <p class="text-xs ${isSynergistic ? 'text-green-400 font-semibold' : 'text-red-400'}">
                            ${isSynergistic ? 'Synergy Bonus!' : 'Standard Role'}
                        </p>
                    `;
                } else {
                    cardContent = `
                        <p class="text-center font-bold text-gray-400">${slot.role}</p>
                        <p class="text-center text-xs text-gray-500">
                            ${isReadyToPlace ? 'Click to Place Card' : 'Empty Slot'}
                        </p>
                    `;
                }

                const slotClass = isReadyToPlace ? 'slot-active' : 'cursor-default';
                const synergyBg = (card && card.role_affinity.includes(slot.role)) ? 'bg-green-900/40' : '';

                crewEl.innerHTML += `
                    <div class="slot p-2 rounded-lg shadow-inner flex flex-col justify-between ${slotClass} ${synergyBg}"
                         onclick="placeCard(${playerId}, ${index})">
                         <p class="font-semibold text-center text-sm mb-1 text-cyan-200">${slot.role}</p>
                        ${cardContent}
                    </div>
                `;
            });

            // Display Score
            const crewCount = gameState.players[playerId].team.filter(s => s.card !== null).length;
            const scoreDisplayEl = document.getElementById(`player-${playerId}-board`).querySelector('h2');
            
            if (crewCount === 6) {
                 gameState.players[playerId].score = calculateScore(gameState.players[playerId].team);
                 scoreDisplayEl.textContent = `Player ${playerId}: Final Score ${gameState.players[playerId].score}`;
            } else if (!scoreDisplayEl.textContent.includes('Final Score')) {
                 scoreDisplayEl.textContent = `Player ${playerId}: Crew (${crewCount}/6)`;
            }
        }
    }

    /**
     * Renders the control button states.
     */
    function renderControls() {
        const drawBtn = document.getElementById('draw-button');
        const skipBtn = document.getElementById('skip-button');
        const player = gameState.players[gameState.currentPlayer];
        
        document.getElementById('player-skip-status').textContent = player.skipped ? '0' : '1';
        
        if (gameState.gameEnded) {
            drawBtn.disabled = true;
            skipBtn.disabled = true;
            return;
        }

        // Draw Button Logic: Enabled only if no card is currently drawn and deck is not empty
        drawBtn.disabled = gameState.cardDrawn || gameState.deck.length === 0;

        // Skip Button Logic: Enabled only if a card is drawn AND player hasn't skipped AND deck is not empty
        skipBtn.disabled = !gameState.cardDrawn || player.skipped;
        if (gameState.deck.length === 0 && gameState.cardDrawn) {
            // Cannot skip if deck is empty (must take the last card)
            skipBtn.disabled = true;
        }
    }

    // --- Game Actions ---

    /**
     * Places the drawn card into a player's crew slot.
     * @param {number} playerId The ID of the player (1 or 2).
     * @param {number} slotIndex The index of the slot in the player's team array.
     */
    function placeCard(playerId, slotIndex) {
        if (gameState.gameEnded || playerId !== gameState.currentPlayer) return;

        // Placement can only happen if a card is currently drawn
        if (!gameState.cardDrawn || gameState.cardPool.length === 0) return;

        const player = gameState.players[playerId];
        const slot = player.team[slotIndex];

        if (slot.card) return; // Slot already filled
        
        // Place the drawn card (the only one in the pool)
        slot.card = gameState.cardPool[0];

        // Clear the card pool and end turn
        gameState.cardPool = [];
        
        endTurn(true); // Placed card, so move to next player
    }

    /**
     * Uses the player's skip action, discarding the current card and drawing a new one.
     */
    function skipTurn() {
        const player = gameState.players[gameState.currentPlayer];
        // Cannot skip if game ended, no card drawn, or already skipped
        if (gameState.gameEnded || !gameState.cardDrawn || player.skipped) return;
        
        // Cannot skip the last card if deck is empty
        if (gameState.deck.length === 0) return; 

        // 1. Use skip allowance
        player.skipped = true;

        // 2. Discard current card and reset the flag (THE FIX)
        gameState.cardPool = [];
        gameState.cardDrawn = false; 
        
        // 3. Draw a new card immediately (stay on the same player's turn)
        // drawCard(false) is called to prevent double rendering.
        drawCard(false); 
        
        // 4. A skip is an action, so increment global turn count
        gameState.totalTurns++;

        renderGame();
    }

    /**
     * Finalizes the turn and switches to the next player if placement occurred.
     * @param {boolean} placementOccurred True if a card was successfully placed.
     */
    function endTurn(placementOccurred) {
        if (placementOccurred) {
            gameState.totalTurns++;
            gameState.cardDrawn = false;
            
            // Switch player
            gameState.currentPlayer = gameState.currentPlayer === 1 ? 2 : 1;
        }

        checkGameEnd();
        renderGame();
    }

    // Initialize the game when the window loads
    window.onload = initGame;

</script>
</body>
</html>

